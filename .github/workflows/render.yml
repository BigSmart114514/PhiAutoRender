name: Install FFmpeg

on: [push]

jobs:
  Render:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo add-apt-repository ppa:jonathonf/ffmpeg-4 -y  # 添加新版FFmpeg仓库
          sudo apt-get install -y \
            ffmpeg \
            xvfb \
            libayatana-appindicator3-1 \
            libwebkit2gtk-4.0-37 \
            libgl1-mesa-glx \
            libgl1-mesa-dri \
            mesa-utils \
            pulseaudio \
            alsa-utils \
            libx264-dev  # 确保H.264编码支持

      - name: Install Phi-Recorder
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/2278535805/Phi-Recorder/releases/latest | jq -r '.tag_name')
          LATEST_VERSION="${LATEST_RELEASE:1}"
          DEB_URL="https://github.com/2278535805/Phi-Recorder/releases/download/v${LATEST_VERSION}/phi-recorder_${LATEST_VERSION}_amd64.deb"
          wget "${DEB_URL}" -O phi-recorder.deb
          sudo dpkg -i phi-recorder.deb || sudo apt-get install -f -y  # 自动修复依赖

      - name: Render with Xvfb
        run: |
          # 配置虚拟音频设备
          echo 'pcm.!default { type null }' > ~/.asoundrc
          echo 'ctl.!default { type null }' >> ~/.asoundrc
          pulseaudio --daemonize --exit-idle-time=-1

          # 设置新版FFmpeg路径（如果需要）
          echo "/usr/bin" >> $GITHUB_PATH

          # 设置环境变量
          export LIBGL_ALWAYS_SOFTWARE=1
          export MESA_GL_VERSION_OVERRIDE=3.3
          export SDL_AUDIODRIVER=pulseaudio
          
          # 验证FFmpeg版本
          ffmpeg -version
          
          # 增加渲染超时时间
          xvfb-run -s "-screen 0 1920x1080x24" timeout 300s phi-recorder --render AbsoluTedisoRdeR.AcuteDisarray-AT.pez --output "ATRR.mp4"
        env:
          RUST_BACKTRACE: 1
